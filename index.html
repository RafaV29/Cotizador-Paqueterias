<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Env√≠os - Tu Empresa</title>
    <style>
        :root {
            --bg: #f4f7f6;
            --card-bg: #fff;
            --text: #333;
            --label: #555;
            --border: #e0e0e0;
            --primary: #007bff;
            --primary-hover: #0056b3;
            --error: #d93025;
            --loader: #555;
        }

        [data-theme="dark"] {
            --bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #e0e0e0;
            --label: #bbb;
            --border: #444;
            --primary: #0069d9;
            --primary-hover: #005cbf;
            --error: #f88;
            --loader: #aaa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            padding: 2em 1em;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: var(--card-bg);
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s;
        }
        h1 { color: var(--text); text-align: center; }
        form { display: flex; flex-direction: column; gap: 20px; }
        .form-section {
            border: 1px solid var(--border);
            padding: 1.5em;
            border-radius: 8px;
        }
        .form-section h3 {
            margin-top: 0;
            color: var(--primary);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        label {
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--label);
        }
        input {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1em;
            background: var(--bg);
            color: var(--text);
        }
        .cp-status {
            font-size: 0.8em;
            color: var(--label);
            position: absolute;
            bottom: -18px;
            left: 0;
            height: 1em;
        }
        button {
            background-color: var(--primary);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 1em;
        }
        button:hover {
            background-color: var(--primary-hover);
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #results-container {
            margin-top: 2em;
        }
        .loader {
            text-align: center;
            font-size: 1.2em;
            color: var(--loader);
        }
        .result-card {
            background: #f9f9f9;
            border: 1px solid var(--border);
            border-left: 5px solid var(--primary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .result-card .carrier {
            font-weight: bold;
            font-size: 1.2em;
            text-transform: capitalize;
        }
        .result-card .price {
            font-size: 1.3em;
            font-weight: bold;
            color: #28a745;
        }
        .error {
            color: var(--error);
            font-weight: bold;
            text-align: center;
        }
        .theme-toggle {
            position: absolute;
            top: 1em;
            right: 1em;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .logo {
            width: 180px;
            margin: 0 auto 1em auto;
            display: block;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">üåô Modo Oscuro</button>

    <div class="container">
        <img id="logo" src="public/logo-light.png" alt="Logo" class="logo">
        <h1>Cotizador de Env√≠os üöö</h1>

        <form id="cotizador-form">
            <div class="form-section">
                <h3>üì¶ Paquete</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="weight">Peso (kg)</label>
                        <input type="number" id="weight" step="0.1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="length">Largo (cm)</label>
                        <input type="number" id="length" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="width">Ancho (cm)</label>
                        <input type="number" id="width" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="height">Alto (cm)</label>
                        <input type="number" id="height" value="10" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üìç Origen</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="origin-name">Nombre</label>
                        <input type="text" id="origin-name" value="Remitente" required>
                    </div>
                    <div class="form-group">
                        <label for="origin-phone">Tel√©fono</label>
                        <input type="text" id="origin-phone" value="5512345678" required>
                    </div>
                    <div class="form-group">
                        <label for="origin-street">Calle</label>
                        <input type="text" id="origin-street" value="Av. Principal" required>
                    </div>
                    <div class="form-group">
                        <label for="origin-number">N√∫mero</label>
                        <input type="text" id="origin-number" value="123" required>
                    </div>
                    <div class="form-group">
                        <label for="origin-district">Colonia</label>
                        <input type="text" id="origin-district" value="Centro" required>
                    </div>
                    <div class="form-group">
                        <label for="origin-postalCode">C√≥digo Postal</label>
                        <input type="text" id="origin-postalCode" required maxlength="5" placeholder="Ej. 03810">
                        <span id="origin-cp-status" class="cp-status"></span>
                    </div>
                    <div class="form-group">
                        <label for="origin-city">Ciudad</label>
                        <input type="text" id="origin-city" required>
                    </div>
                    <div class="form-group">
                        <label for="origin-state">Estado</label>
                        <input type="text" id="origin-state" required readonly>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üèÅ Destino</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="destination-name">Nombre</label>
                        <input type="text" id="destination-name" value="Destinatario" required>
                    </div>
                    <div class="form-group">
                        <label for="destination-phone">Tel√©fono</label>
                        <input type="text" id="destination-phone" value="5512345678" required>
                    </div>
                    <div class="form-group">
                        <label for="destination-street">Calle</label>
                        <input type="text" id="destination-street" value="Av. Central" required>
                    </div>
                    <div class="form-group">
                        <label for="destination-number">N√∫mero</label>
                        <input type="text" id="destination-number" value="456" required>
                    </div>
                    <div class="form-group">
                        <label for="destination-district">Colonia</label>
                        <input type="text" id="destination-district" value="Del Valle" required>
                    </div>
                    <div class="form-group">
                        <label for="destination-postalCode">C√≥digo Postal</label>
                        <input type="text" id="destination-postalCode" required maxlength="5" placeholder="Ej. 55120">
                        <span id="destination-cp-status" class="cp-status"></span>
                    </div>
                    <div class="form-group">
                        <label for="destination-city">Ciudad</label>
                        <input type="text" id="destination-city" required>
                    </div>
                    <div class="form-group">
                        <label for="destination-state">Estado</label>
                        <input type="text" id="destination-state" required readonly>
                    </div>
                </div>
            </div>

            <button type="submit" id="submit-button">Cotizar Env√≠o</button>
        </form>

        <div id="results-container"></div>
    </div>

    <script>
        // üåô Cambiar entre modo oscuro y claro
        function toggleTheme() {
            const html = document.documentElement;
            const logo = document.getElementById('logo');
            const button = document.querySelector('.theme-toggle');
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                logo.src = 'public/logo-light.png';
                button.textContent = 'üåô Modo Oscuro';
            } else {
                html.setAttribute('data-theme', 'dark');
                logo.src = 'public/logo-dark.png';
                button.textContent = '‚òÄÔ∏è Modo Claro';
            }
        }

        // üîß Configuraci√≥n de GitHub
        const GITHUB_USER = 'RafaV29';
        const GITHUB_REPO = 'cps-mexico';
        const BASE_URL = `https://${GITHUB_USER}.github.io/${GITHUB_REPO}`;

        // üî¢ Mapeo de los primeros 2 d√≠gitos del CP ‚Üí estado clave
        const cpToEstado = {
            "01": "CDMX", "02": "CDMX", "03": "CDMX", "04": "CDMX", "05": "CDMX", "06": "CDMX", "07": "CDMX", "08": "CDMX", "09": "CDMX",
            "10": "EM", "11": "EM", "12": "EM", "13": "EM", "14": "EM", "15": "EM", "16": "EM", "17": "EM", "18": "EM", "19": "EM",
            "20": "AG", "21": "BC", "22": "BC", "23": "BS", "24": "CM", "25": "CS", "26": "CH", "27": "CO", "28": "CL", "29": "DG",
            "30": "GT", "31": "GR", "32": "HG", "33": "JA", "34": "EM", "35": "DG", "36": "GT", "37": "MI", "38": "MO", "39": "NA",
            "40": "NL", "41": "NL", "42": "NL", "43": "NL", "44": "NL", "45": "NL", "46": "NL", "47": "NL", "48": "NL", "49": "NL",
            "50": "EM", "51": "EM", "52": "EM", "53": "EM", "54": "EM", "55": "EM", "56": "EM", "57": "EM", "58": "MI", "59": "MI",
            "60": "MZ", "61": "MZ", "62": "OA", "63": "OA", "64": "NL", "65": "NL", "66": "NL", "67": "NL", "68": "OA", "69": "OA",
            "70": "CH", "71": "CH", "72": "PU", "73": "PU", "74": "PU", "75": "PU", "76": "PU", "77": "QR", "78": "SL", "79": "SL",
            "80": "SI", "81": "SI", "82": "SI", "83": "SO", "84": "SO", "85": "SO", "86": "TB", "87": "TM", "88": "TM", "89": "TM",
            "90": "TL", "91": "VE", "92": "VE", "93": "VE", "94": "VE", "95": "VE", "96": "VE", "97": "YU", "98": "ZT", "99": "ZT"
        };

        // üó∫Ô∏è Nombre completo del estado
        const nombreEstado = {
            "AG": "Aguascalientes",
            "BC": "Baja California",
            "BS": "Baja California Sur",
            "CM": "Campeche",
            "CS": "Chiapas",
            "CH": "Chihuahua",
            "CDMX": "Ciudad de M√©xico",
            "CO": "Coahuila",
            "CL": "Colima",
            "DG": "Durango",
            "GT": "Guanajuato",
            "GR": "Guerrero",
            "HG": "Hidalgo",
            "JA": "Jalisco",
            "EM": "M√©xico",
            "MI": "Michoac√°n",
            "MO": "Morelos",
            "NA": "Nayarit",
            "NL": "Nuevo Le√≥n",
            "OA": "Oaxaca",
            "PU": "Puebla",
            "QT": "Quer√©taro",
            "QR": "Quintana Roo",
            "SL": "San Luis Potos√≠",
            "SI": "Sinaloa",
            "SO": "Sonora",
            "TB": "Tabasco",
            "TM": "Tamaulipas",
            "TL": "Tlaxcala",
            "VE": "Veracruz",
            "YU": "Yucat√°n",
            "ZA": "Zacatecas"
        };

        // üì¶ Mapeo de estado clave ‚Üí archivo JSON
        const estadoJsonMap = {
            "AG": "CP_AGUASCALIENTES",
            "BC": "CP_BAJA_CALIFORNIA_NORTE",
            "BS": "CP_BAJA_CALIFORNIA_SUR",
            "CM": "CP_CAMPECHE",
            "CS": "CP_CHIAPAS",
            "CH": "CP_CHIHUAHUA",
            "CO": "CP_COAHUILA",
            "CL": "CP_COLIMA",
            "DG": "CP_DURANGO",
            "GT": "CP_GUANAJUATO",
            "GR": "CP_GUERRERO",
            "HG": "CP_HIDALGO",
            "JA": "CP_JALISCO",
            "EM": "CP_EDO_MEX",
            "MI": "CP_MICHOACAN",
            "MO": "CP_MORELOS",
            "NA": "CP_NAYARIT",
            "NL": "CP_NUEVO_LEON",
            "OA": "CP_OAXACA",
            "PU": "CP_PUEBLA",
            "QT": "CP_QUERETARO",
            "QR": "CP_QUINTANA_ROO",
            "SL": "CP_SAN_LUIS_POTOSI",
            "SI": "CP_SINALOA",
            "SO": "CP_SONORA",
            "TB": "CP_TABASCO",
            "TM": "CP_TAMAULIPAS",
            "TL": "CP_TLAXCALA",
            "VE": "CP_VERACRUZ",
            "YU": "CP_YUCATAN",
            "ZA": "CP_ZACATECAS"
        };

        // ‚úÖ Autocompletar desde GitHub
        async function autocompletarDesdeGitHub(tipo) {
            const cpInput = document.getElementById(`${tipo}-postalCode`);
            const cityInput = document.getElementById(`${tipo}-city`);
            const stateInput = document.getElementById(`${tipo}-state`);
            const statusSpan = document.getElementById(`${tipo}-cp-status`);

            const cp = cpInput.value.trim();
            cityInput.value = '';
            stateInput.value = '';
            statusSpan.textContent = '';

            console.log('üîç [Autocompletar] C√≥digo postal ingresado:', cp);

            if (cp.length !== 5 || !/^\d{5}$/.test(cp)) {
                statusSpan.textContent = 'CP inv√°lido.';
                statusSpan.style.color = 'red';
                console.warn('‚ùå CP no v√°lido:', cp);
                return;
            }

            const cpPrefix = cp.substring(0, 2);
            console.log('üî¢ Prefijo (2 d√≠gitos):', cpPrefix);

            const estadoClave = cpToEstado[cpPrefix];
            console.log('üîë Estado clave mapeado:', estadoClave);

            if (!estadoClave) {
                statusSpan.textContent = 'Estado no soportado.';
                statusSpan.style.color = 'red';
                console.error('‚ùå No se encontr√≥ estado para el prefijo:', cpPrefix);
                return;
            }

            const estadoNombre = nombreEstado[estadoClave];
            console.log('üìå Nombre del estado:', estadoNombre);

            const codigo2D = {
                "Aguascalientes": "AG",
                "Baja California": "BC",
                "Baja California Sur": "BS",
                "Campeche": "CM",
                "Chiapas": "CS",
                "Chihuahua": "CH",
                "Ciudad de M√©xico": "CX",
                "Coahuila": "CO",
                "Colima": "CL",
                "Durango": "DG",
                "Guanajuato": "GT",
                "Guerrero": "GR",
                "Hidalgo": "HG",
                "Jalisco": "JA",
                "M√©xico": "EM",
                "Michoac√°n": "MI",
                "Morelos": "MO",
                "Nayarit": "NA",
                "Nuevo Le√≥n": "NL",
                "Oaxaca": "OA",
                "Puebla": "PU",
                "Quer√©taro": "QT",
                "Quintana Roo": "QR",
                "San Luis Potos√≠": "SL",
                "Sinaloa": "SI",
                "Sonora": "SO",
                "Tabasco": "TB",
                "Tamaulipas": "TM",
                "Tlaxcala": "TL",
                "Veracruz": "VE",
                "Yucat√°n": "YU",
                "Zacatecas": "ZA"
            }[estadoNombre];

            if (!codigo2D) {
                statusSpan.textContent = 'C√≥digo de estado inv√°lido.';
                statusSpan.style.color = 'red';
                console.error('‚ùå No se encontr√≥ c√≥digo 2D para:', estadoNombre);
                return;
            }

            const jsonKey = estadoJsonMap[codigo2D];
            if (!jsonKey) {
                statusSpan.textContent = 'Archivo no disponible.';
                statusSpan.style.color = 'red';
                console.error('‚ùå No hay archivo JSON para:', codigo2D);
                return;
            }

            const url = `${BASE_URL}/${jsonKey}.json`;
            console.log('üåê URL del JSON:', url);

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('‚ùå Error al cargar JSON:', response.status, response.statusText);
                    throw new Error('No disponible');
                }

                const data = await response.json();
                console.log('‚úÖ JSON cargado con', data.length, 'registros');

                const asentamiento = data.find(item => item.d_codigo === cp);
                console.log('üîé B√∫squeda de CP:', cp, '‚Üí Encontrado:', asentamiento ? 'S√≠' : 'No');

                if (asentamiento) {
                    const ciudad = asentamiento.d_mnpio || asentamiento.d_ciudad || estadoNombre;
                    cityInput.value = ciudad;
                    stateInput.value = codigo2D;
                    statusSpan.textContent = `‚úì ${ciudad}`;
                    statusSpan.style.color = 'green';
                    console.log('‚úÖ Autocompletado exitoso:', { ciudad, estado: codigo2D });
                } else {
                    statusSpan.textContent = 'CP no encontrado.';
                    statusSpan.style.color = 'orange';
                    console.warn('üü° CP no encontrado en el archivo JSON');
                }
            } catch (error) {
                console.error('üö® Error en autocompletado:', error);
                statusSpan.textContent = 'Error al cargar datos.';
                statusSpan.style.color = 'red';
            }
        }

        // üîó Asociar eventos
        document.getElementById('origin-postalCode').addEventListener('blur', () => autocompletarDesdeGitHub('origin'));
        document.getElementById('destination-postalCode').addEventListener('blur', () => autocompletarDesdeGitHub('destination'));

        // üöö Intentar con m√∫ltiples carriers
        const carriersToTry = ["fedex", "dhl", "estafeta", "paquetexpress", "redpack", "ninetynineminutes"];

        async function cotizarConMultiplesCarriers() {
            const resultsContainer = document.getElementById('results-container');
            const submitButton = document.getElementById('submit-button');

            resultsContainer.innerHTML = '<div class="loader">Probando carriers...</div>';
            submitButton.disabled = true;

            const originState = document.getElementById('origin-state').value;
            const destinationState = document.getElementById('destination-state').value;

            if (originState.length !== 2) {
                resultsContainer.innerHTML = '<div class="error">Estado de origen debe tener 2 letras.</div>';
                submitButton.disabled = false;
                return;
            }

            if (destinationState.length !== 2) {
                resultsContainer.innerHTML = '<div class="error">Estado de destino debe tener 2 letras.</div>';
                submitButton.disabled = false;
                return;
            }

            const todasLasCotizaciones = [];

            for (const carrier of carriersToTry) {
                resultsContainer.innerHTML = `<div class="loader">Probando con ${carrier.toUpperCase()}...</div>`;
                const cotizaciones = await cotizarConCarrier(carrier);
                if (cotizaciones) {
                    todasLasCotizaciones.push(...cotizaciones);
                }
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            if (todasLasCotizaciones.length > 0) {
                mostrarResultados(todasLasCotizaciones);
            } else {
                resultsContainer.innerHTML = '<div class="error">No se encontraron cotizaciones.</div>';
            }

            submitButton.disabled = false;
        }

        async function cotizarConCarrier(carrier) {
            const origin = {
                name: document.getElementById('origin-name').value,
                phone: document.getElementById('origin-phone').value,
                street: document.getElementById('origin-street').value,
                number: document.getElementById('origin-number').value,
                district: document.getElementById('origin-district').value,
                city: document.getElementById('origin-city').value,
                state: document.getElementById('origin-state').value,
                country: "MX",
                postalCode: document.getElementById('origin-postalCode').value
            };

            const destination = {
                name: document.getElementById('destination-name').value,
                phone: document.getElementById('destination-phone').value,
                street: document.getElementById('destination-street').value,
                number: document.getElementById('destination-number').value,
                district: document.getElementById('destination-district').value,
                city: document.getElementById('destination-city').value,
                state: document.getElementById('destination-state').value,
                country: "MX",
                postalCode: document.getElementById('destination-postalCode').value
            };

            const packages = [{
                content: "Producto",
                amount: 1,
                type: "box",
                weight: parseFloat(document.getElementById('weight').value),
                insurance: 0,
                declaredValue: 0,
                weightUnit: "KG",
                lengthUnit: "CM",
                dimensions: {
                    length: parseInt(document.getElementById('length').value),
                    width: parseInt(document.getElementById('width').value),
                    height: parseInt(document.getElementById('height').value)
                }
            }];

            console.log('üì§ Enviando a API:', {
                origin,
                destination,
                packages,
                shipment: { type: 0, carrier }
            });

            try {
                const response = await fetch('https://cotizador-paqueterias.vercel.app/api/rate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin,
                        destination,
                        packages,
                        shipment: {
                            type: 0,
                            carrier: carrier  // ‚úÖ Corregido: dentro de shipment
                        }
                    })
                });

                const data = await response.json();
                console.log('üì• Respuesta de API:', data);

                if (response.ok && data?.data?.length > 0) {
                    return data.data;
                }
                return null;
            } catch (err) {
                console.error(`Error con ${carrier}:`, err);
                return null;
            }
        }

        function mostrarResultados(cotizaciones) {
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '<h2>‚úÖ Cotizaciones</h2>';
            cotizaciones.forEach(quote => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div>
                        <div class="carrier">${quote.carrierDescription || quote.carrier} (${quote.service})</div>
                        <div>Entrega: ${quote.deliveryEstimate || 'No disponible'}</div>
                    </div>
                    <div class="price">$${parseFloat(quote.totalPrice).toFixed(2)} ${quote.currency}</div>
                `;
                resultsContainer.appendChild(card);
            });
        }

        // ‚úÖ Evento del formulario
        document.getElementById('cotizador-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await cotizarConMultiplesCarriers();
        });
    </script>
</body>
</html>
